<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-deploy/install_infra" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Infrastructure installation | ETF Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://example.com/reference-environment/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://example.com/reference-environment/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://example.com/reference-environment/deploy/install_infra"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Infrastructure installation | ETF Documentation"><meta data-rh="true" name="description" content="Overview"><meta data-rh="true" property="og:description" content="Overview"><link data-rh="true" rel="icon" href="/reference-environment/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://example.com/reference-environment/deploy/install_infra"><link data-rh="true" rel="alternate" href="https://example.com/reference-environment/deploy/install_infra" hreflang="en"><link data-rh="true" rel="alternate" href="https://example.com/reference-environment/deploy/install_infra" hreflang="x-default"><link rel="stylesheet" href="/reference-environment/assets/css/styles.6c722cd9.css">
<script src="/reference-environment/assets/js/runtime~main.2095a558.js" defer="defer"></script>
<script src="/reference-environment/assets/js/main.54967688.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/reference-environment/"><div class="navbar__logo"><img src="/reference-environment/img/logo.svg" alt="ETF Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/reference-environment/img/logo.svg" alt="ETF Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">ETF</b></a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input searchInput_YFbd" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/reference-environment/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/reference-environment/deploy/install_infra">Deploy</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/reference-environment/deploy/install_infra">Infrastructure installation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/reference-environment/deploy/keycloak">Keycloak</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/reference-environment/deploy/install_components">Components installation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/reference-environment/deploy/argocd_applications">Notes on ArgoCD Applications</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/reference-environment/operate/components">Operate</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/reference-environment/use">Use</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/reference-environment/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Deploy</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Infrastructure installation</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Infrastructure installation</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h2>
<p>This guide provides installation instructions, usage guidelines, and troubleshooting tips for the main Kubernetes infrastructure used in the InnerData X Confiance.AI project. The components covered include OpenTofu scripts and Helm Charts.
What is called <em>Kubernetes Infrastructure</em> in this project is the set of middleware applications needed to manage InnerData and Confiance components. Main Helm charts required to enable security, observability, and GitOps practices. Clone the present repository locally.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>OpenTofu is used in this project as <a href="https://www.hashicorp.com/license-faq" target="_blank" rel="noopener noreferrer">Terraform is no longer a FOSS tool</a>. The scripts may be compatible with Terraform but we do not guarantee it.</p></div></div>
<p>Deployed applications during this section:</p>
<table><thead><tr><th style="text-align:center">Application</th><th style="text-align:center">Helm repo</th><th style="text-align:center">Chart name</th><th style="text-align:center">Namespace</th><th>Host</th></tr></thead><tbody><tr><td style="text-align:center">ArgoCD</td><td style="text-align:center"><a href="https://argoproj.github.io/argo-helm" target="_blank" rel="noopener noreferrer">https://argoproj.github.io/argo-helm</a></td><td style="text-align:center">argo-cd</td><td style="text-align:center">argocd</td><td><code>argocd.&lt;BASE_DOMAIN&gt;</code></td></tr><tr><td style="text-align:center">Cert-Manager</td><td style="text-align:center"><a href="https://charts.jetstack.io" target="_blank" rel="noopener noreferrer">https://charts.jetstack.io</a></td><td style="text-align:center">cert-manager</td><td style="text-align:center">cert-manager</td><td></td></tr><tr><td style="text-align:center">Alloy Stack</td><td style="text-align:center"><a href="https://grafana.github.io/helm-charts" target="_blank" rel="noopener noreferrer">https://grafana.github.io/helm-charts</a></td><td style="text-align:center">k8s-monitoring</td><td style="text-align:center">alloy</td><td></td></tr><tr><td style="text-align:center">Grafana</td><td style="text-align:center"><a href="https://prometheus-community.github.io/helm-charts" target="_blank" rel="noopener noreferrer">https://prometheus-community.github.io/helm-charts</a></td><td style="text-align:center">kube-prometheus-stack</td><td style="text-align:center">grafana</td><td><code>monitoring.&lt;BASE_DOMAIN&gt;</code></td></tr><tr><td style="text-align:center">Loki</td><td style="text-align:center"><a href="https://grafana.github.io/helm-charts" target="_blank" rel="noopener noreferrer">https://grafana.github.io/helm-charts</a></td><td style="text-align:center">loki</td><td style="text-align:center">loki</td><td></td></tr><tr><td style="text-align:center">Mimir</td><td style="text-align:center"><a href="https://grafana.github.io/helm-charts" target="_blank" rel="noopener noreferrer">https://grafana.github.io/helm-charts</a></td><td style="text-align:center">mimir-distributed</td><td style="text-align:center">mimir</td><td></td></tr><tr><td style="text-align:center">Gitlab Runner</td><td style="text-align:center"><a href="https://charts.gitlab.io" target="_blank" rel="noopener noreferrer">https://charts.gitlab.io</a></td><td style="text-align:center">gitlab-runner</td><td style="text-align:center">gitlab-runner</td><td></td></tr><tr><td style="text-align:center">Ingress NGINX</td><td style="text-align:center"><a href="https://kubernetes.github.io/ingress-nginx" target="_blank" rel="noopener noreferrer">https://kubernetes.github.io/ingress-nginx</a></td><td style="text-align:center">ingress-nginx</td><td style="text-align:center">ingress-nginx</td><td></td></tr><tr><td style="text-align:center">Keycloak</td><td style="text-align:center"><a href="https://charts.bitnami.com/bitnami" target="_blank" rel="noopener noreferrer">https://charts.bitnami.com/bitnami</a></td><td style="text-align:center">keycloak</td><td style="text-align:center">keycloak</td><td><code>auth.&lt;BASE_DOMAIN&gt;</code></td></tr><tr><td style="text-align:center">MetalLB</td><td style="text-align:center"><a href="https://metallb.github.io/metallb" target="_blank" rel="noopener noreferrer">https://metallb.github.io/metallb</a></td><td style="text-align:center">metallb</td><td style="text-align:center">metallb</td><td></td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="structure">Structure<a href="#structure" class="hash-link" aria-label="Direct link to Structure" title="Direct link to Structure">​</a></h3>
<p>The <code>infra/</code> directory contains the infrastructure-related files and configurations required to deploy and manage the Kubernetes infrastructure for the InnerData X Confiance.AI project. This includes OpenTofu scripts, Helm values, Terraform configurations, and other necessary resources to set up and maintain the infrastructure.</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">infra/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── helm-values/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── argocd.ref.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── argocd.override.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── loki.ref.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── loki.override.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── modules/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── helm/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       ├── main.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       └── variables.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── .terraform.lock.hcl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── main.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── providers.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── secrets.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── variables.tf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>
<p><strong>helm-values/</strong>: Contains Helm values files for various components such as ArgoCD, Loki, MetalLB, Mimir, and NGINX. These files define the configuration and values used during the Helm chart deployments. There is always a pair of values files: the <code>.ref.yaml</code> containing the original values from the chart regristry, and the <code>.override.yaml</code> which are modified following our needs, and which will take precedency during the deployment.</p>
</li>
<li>
<p><strong>modules/</strong>: Contains reusable Tofu modules for deploying Helm charts and managing component secrets.</p>
<ul>
<li><code>helm/</code>: Module for deploying Helm charts using Tofu.</li>
</ul>
</li>
<li>
<p><strong>main.tf</strong>: Main Tofu configuration file that defines the infrastructure resources and their dependencies.</p>
</li>
<li>
<p><strong>providers.tf</strong>: Defines the required Tofu providers and their versions.</p>
</li>
<li>
<p><strong>secrets.tf</strong>: Contains Tofu configurations for managing Kubernetes secrets and Gitlab CI variables for both middlewares and components.</p>
</li>
<li>
<p><strong>variables.tf</strong>: Defines the input variables used in the Tofu configurations.</p>
</li>
</ul>
<p>This structure ensures that the infrastructure setup is modular, reusable, and easy to manage, providing a clear separation of concerns and facilitating the deployment and maintenance of the Kubernetes infrastructure.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="infrastructure-prerequisites">Infrastructure prerequisites<a href="#infrastructure-prerequisites" class="hash-link" aria-label="Direct link to Infrastructure prerequisites" title="Direct link to Infrastructure prerequisites">​</a></h2>
<ul>
<li>Have admin access to a Kubernetes cluster</li>
<li>Have access to an S3-compatible storage system</li>
<li>Created a domain name and be able to change the A entry to point towards NGINX Ingress Controller Load Balancer service IP address</li>
<li>If the environment is only accessible through a VPN, make sure you have a compatible endpoint with Cert-Manager Let&#x27;s Encrypt DNS01 challenge mechanism</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="installation">Installation<a href="#installation" class="hash-link" aria-label="Direct link to Installation" title="Direct link to Installation">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a href="#prerequisites" class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites">​</a></h3>
<p>Install tofu (version &gt;= 1.9) locally or use the tofu Docker image. The latter will be used throughout the installation steps. The state can be stored everywhere (but locally), the preferred places being in an S3-compatible storage, or using <a href="https://docs.gitlab.com/ee/user/infrastructure/iac/terraform_state.html" target="_blank" rel="noopener noreferrer">Gitlab state backend</a>. See <a href="https://opentofu.org/docs/language/settings/backends/http/#configuration-variables" target="_blank" rel="noopener noreferrer">OpenTofu documentation</a> for backend configuration.</p>
<p>Ensure you have access to the Kubernetes cluster and set it as your current context.</p>
<p>The <code>infra/</code> directory contains the instructions to deploy a set of Helm charts resources with OpenTofu. Create a Gitlab CI variable of type &quot;File&quot; called <code>MAIN_TFVARS</code>, and fill following variables:</p>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Local Kubernetes context name pointing to desired Kubernetes cluster</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">kube_context</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Gitlab Runner registration token (See https://docs.gitlab.com/runner/register/#register-with-a-runner-registration-token-deprecated)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">gitlab_reg_token</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Gitlab repository&#x27;s access token, used to add CI variables</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">gitlab_project_token</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Gitlab Project ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">gitlab_project_id</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7934</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Grafana admin password</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">grafana_admin_password</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Corporate email address for Let&#x27;s Encrypt certificate request</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">le_email_address</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Gitlab URL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">gitlab_url</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Gitlab ArgoCD user</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">gitlab_argocd_user</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Gitlab ArgoCD token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">gitlab_argocd_token</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Corporate email address for Let&#x27;s Encrypt certificate request</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">le_email_address</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Ingress class name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">ingress_class_name</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Keycloak cluster issuer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">kc_cluster_issuer</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Docker Hub server. Leave it empty or set it to your private registry.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">container_registry_server</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Docker Hub username</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">container_registry_username</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Docker Hub password</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">container_registry_password</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Internal container registry server</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">internal_container_registry_server</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Internal container registry username</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">internal_container_registry_username</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Internal container registry password</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">internal_container_registry_password</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Grafana OAuth client ID created in Keycloak</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">grafana_oauth_client_id</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Grafana OAuth client secret created in Keycloak</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">grafana_oauth_client_secret</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Base domain name. Example: etf-foundation.com</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">base_domain</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Keycloak Realm name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">realm_name</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Helm secrets image tag</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">helm_secrets_image_tag</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Cert challenge DNS01 application key</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">cert_challenge_dns01_application_key</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Cert challenge DNS01 secret name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">cert_challenge_dns01_secret_name</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Cert challenge DNS01 consumer key</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">cert_challenge_dns01_consumer_key</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Cert challenge DNS01 endpoint</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">cert_challenge_dns01_endpoint</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Cert challenge DNS01 group name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">cert_challenge_dns01_group_name</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Cert challenge DNS01 solver name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">cert_challenge_dns01_solver_name</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># External S3 region</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">s3_region</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># External S3 access key ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">s3_access_key_id</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># External S3 secret access key</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">s3_secret_access_key</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># External S3 endpoint</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">s3_endpoint</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># JupyterHub client secret created later in Keycloak. Can be set to null at the beginning.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">jupyterhub_client_secret</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># MinIO client secret created later in Keycloak. Can be set to null at the beginning.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">minio_client_secret</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Argo Workflows client ID created later in Keycloak. Can be set to null at the beginning.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">workflows_sso_client_id</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Argo Workflows client secret created later in Keycloak. Can be set to null at the beginning.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">workflows_sso_client_secret</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Docusaurus client secret created later in Keycloak. Can be set to null at the beginning.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">docusaurus_client_secret</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> null</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Then, create the following Gitlab CI Variables:</p>
<ul>
<li>To use Tofu in Gitlab CI, create a new Access Token on the project having <code>api</code> scope and at least <code>Developer</code> role. Then create a CI Variable called <code>TF_HTTP_PASSWORD</code> and having the token&#x27;s value.</li>
<li>For ArgoCD, follow <a href="https://github.com/helmfile/vals?tab=readme-ov-file#gitlab-secrets" target="_blank" rel="noopener noreferrer">vals documentation</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="deployment">Deployment<a href="#deployment" class="hash-link" aria-label="Direct link to Deployment" title="Direct link to Deployment">​</a></h3>
<!-- -->
<p>Before installing MetalLB, see <a href="https://metallb.universe.tf/installation/" target="_blank" rel="noopener noreferrer">official documentation</a> for specific settings depending on your infrastructure implementation. Create the <a href="https://metallb.universe.tf/configuration/" target="_blank" rel="noopener noreferrer">IPAddressPool</a> that will allow Kubernetes Services to use the declared addresses as external IP addresses:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> metallb.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> IPAddressPool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ip</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">pool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> metallb</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">addresses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 192.168.254.50/29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">```</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">```shell</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd infra/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export TOFU_VERSION=1.9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo docker run ghcr.io/opentofu/opentofu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">TOFU_VERSION</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo docker run ghcr.io/opentofu/opentofu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">TOFU_VERSION</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> fmt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo docker run ghcr.io/opentofu/opentofu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">TOFU_VERSION</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> validate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Step 01: Install base infrastructure. We exclude the cluster issuers as the CRD are not currently installed and it will make tofu fail</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo docker run ghcr.io/opentofu/opentofu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">TOFU_VERSION</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> plan </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">out main.tfplan </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">lock=false </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">exclude module.grafana </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">exclude module.argocd </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">exclude kubernetes_manifest.cluster_issuer_le_staging </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">exclude kubernetes_manifest.cluster_issuer_le_prod </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">var</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">file=main.tfvars</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo docker run ghcr.io/opentofu/opentofu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">TOFU_VERSION</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> apply tfplan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Step 02: Install cert-manager ClusterIssuers CRDs and OVH DNS01-challenge files (if needed, otherwise the HTTP01 would be recommended)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo docker run ghcr.io/opentofu/opentofu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">TOFU_VERSION</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> plan </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">out main.tfplan </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">lock=false </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">exclude module.grafana </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">exclude module.argocd </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">var</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">file=main.tfvars</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Step 02 - B: Follow the README on https://github.com/baarde/cert-manager-webhook-ovh for DNS01 challenge over a VPN</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="lets-encrypt-production-test">Let&#x27;s Encrypt production test<a href="#lets-encrypt-production-test" class="hash-link" aria-label="Direct link to Let&#x27;s Encrypt production test" title="Direct link to Let&#x27;s Encrypt production test">​</a></h3>
<p>You can test your Let&#x27;s Encrypt configuration after running the step 2. Follow the <a href="https://cert-manager.io/docs/tutorials/acme/http-validation/#issuing-an-acme-certificate-using-http-validation" target="_blank" rel="noopener noreferrer">Cert Manager documentation</a> to understand why you should do so. You only have to change the value of the Tofu variable <code>kc_cluster_issuer</code> to <code>letsencrypt-staging</code>, deploy the platform and then check if the certificates are issued. If so, you can revert your changes to <code>kc_cluster_issuer</code> and deploy the platform again.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="keycloak-configuration">Keycloak configuration<a href="#keycloak-configuration" class="hash-link" aria-label="Direct link to Keycloak configuration" title="Direct link to Keycloak configuration">​</a></h3>
<p>You now have to configure Keycloak and create the needded clients. Refer to the following guides for configuring Keycloak with ArgoCD and Grafana:</p>
<ul>
<li><a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/user-management/keycloak/" target="_blank" rel="noopener noreferrer">ArgoCD Keycloak integration</a></li>
<li><a href="https://grafana.com/docs/grafana/latest/setup-grafana/configure-security/configure-authentication/keycloak/" target="_blank" rel="noopener noreferrer">Grafana Keycloak integration</a></li>
</ul>
<p>Then, refer to our <a href="/reference-environment/deploy/keycloak">dedicated documentation</a>.</p>
<p>Once Keycloak has been configured, you can deploy the rest of the applications using Gitlab CI. Run the jobs in the <code>🐋 images_build</code> and <code>🟨 tofu</code> stages. Please see the <code>.gitlab-ci.yml</code> file for a description of the jobs.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="argocd-configuration">ArgoCD configuration<a href="#argocd-configuration" class="hash-link" aria-label="Direct link to ArgoCD configuration" title="Direct link to ArgoCD configuration">​</a></h3>
<ul>
<li>In ArgoCD, create a new project called <code>prod</code>
<ul>
<li>Add a destination: <code>https://kubernetes.default.svc</code>, <code>in-cluster</code>, <code>*</code> namespaces</li>
<li>Add source repository: <code>*</code></li>
</ul>
</li>
<li>In your Git instance, create an access token for ArgoCD and copy it</li>
<li>In ArgoCD, in Settings &gt; Repositories &gt; Connect Repo, add this repository:<!-- -->
<ul>
<li>Connection method: via HTTPS</li>
<li>Type: git</li>
<li>Project: <code>prod</code></li>
<li>Repository URL: <code>https://your-instance.com/repo.git</code></li>
<li>Username: <code>argocd</code></li>
<li>Password: paste the token you generated</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="grafana-configuration">Grafana configuration<a href="#grafana-configuration" class="hash-link" aria-label="Direct link to Grafana configuration" title="Direct link to Grafana configuration">​</a></h3>
<p>Add Loki as the logs source by going to <strong>Connections &gt; Add new connection &gt; Loki</strong> and then click on <em>Add new datasource</em>. Then, set <code>http://loki-gateway.loki.svc.cluster.local</code> as the URL and click on <em>Save and Test</em>. You can now explore the logs on <strong>Explore &gt; Logs</strong> or you can also import a <a href="https://grafana.com/grafana/dashboards/13186-loki-dashboard/" target="_blank" rel="noopener noreferrer">dedicated Grafana Hub dashboard</a> on <strong>Dashboards &gt; New &gt; Import</strong>:</p>
<ul>
<li>Paste this number: <code>13186</code></li>
<li>Then, edit the dashboard by changing the variables:<!-- -->
<ul>
<li><code>metric</code>: set to <code>kube_pod_container_info, namespace=$namespace</code></li>
<li><code>workload</code>: delete this variable</li>
</ul>
</li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>For RBAC considerations, it is possible to create new folder Admin, restrict access Admin users only and move all the dashboards in there. Then, create or copy unrestricted dashboards in the root folder.</p></div></div>
<p>To monitor GPU metrics, consider importing those two dashboards:</p>
<ul>
<li><a href="https://grafana.com/grafana/dashboards/10646-kubernetes-deployment-metrics-with-gpu/" target="_blank" rel="noopener noreferrer">Kubernetes Deployment Metrics with GPU</a></li>
<li><a href="https://grafana.com/grafana/dashboards/12239-nvidia-dcgm-exporter-dashboard/" target="_blank" rel="noopener noreferrer">NVIDIA DCGM Exporter Dashboard</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="follow-up">Follow-up<a href="#follow-up" class="hash-link" aria-label="Direct link to Follow-up" title="Direct link to Follow-up">​</a></h2>
<p>The components are now ready to be installed. Please follow the <a href="/reference-environment/deploy/install_components">dedicated documentation</a>.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/reference-environment/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Introduction</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/reference-environment/deploy/keycloak"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Keycloak</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a><ul><li><a href="#structure" class="table-of-contents__link toc-highlight">Structure</a></li></ul></li><li><a href="#infrastructure-prerequisites" class="table-of-contents__link toc-highlight">Infrastructure prerequisites</a></li><li><a href="#installation" class="table-of-contents__link toc-highlight">Installation</a><ul><li><a href="#prerequisites" class="table-of-contents__link toc-highlight">Prerequisites</a></li><li><a href="#deployment" class="table-of-contents__link toc-highlight">Deployment</a></li><li><a href="#lets-encrypt-production-test" class="table-of-contents__link toc-highlight">Let&#39;s Encrypt production test</a></li><li><a href="#keycloak-configuration" class="table-of-contents__link toc-highlight">Keycloak configuration</a></li><li><a href="#argocd-configuration" class="table-of-contents__link toc-highlight">ArgoCD configuration</a></li><li><a href="#grafana-configuration" class="table-of-contents__link toc-highlight">Grafana configuration</a></li></ul></li><li><a href="#follow-up" class="table-of-contents__link toc-highlight">Follow-up</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Built by ETF with Docusaurus.</div></div></div></footer></div>
</body>
</html>